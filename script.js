quizzes = [
    {
        "id": 3,
        "name": "Puissance Soul",
        "questions": [
            {
                "id": 13,
                "question": "Qui est l'interpr\u00e8te de ce \"tube\" de 1971 ?",
                "deezer_song_id": "https:\/\/cdns-preview-4.dzcdn.net\/stream\/c-43e45cffe743b6b6b3ed48044a101bb3-4.mp3",
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 39,
                        "answer": "Mikael Jackson",
                        "question_id": 13,
                        "right_answer": 0
                    },
                    {
                        "id": 40,
                        "answer": "Marvin Gaye",
                        "question_id": 13,
                        "right_answer": 1
                    },
                    {
                        "id": 41,
                        "answer": "Lionel Richie",
                        "question_id": 13,
                        "right_answer": 0
                    },
                    {
                        "id": 42,
                        "answer": "Otis Redding",
                        "question_id": 13,
                        "right_answer": 0
                    }
                ]
            },
            {
                "id": 16,
                "question": "Qui est surnomm\u00e9 \u00ab The Godfather of Soul \u00bb et \u00ab Mister Dynamite \u00bb ?",
                "deezer_song_id": null,
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 52,
                        "answer": "Marvin Gaye",
                        "question_id": 16,
                        "right_answer": 0
                    },
                    {
                        "id": 53,
                        "answer": "James Brown",
                        "question_id": 16,
                        "right_answer": 1
                    },
                    {
                        "id": 54,
                        "answer": "Curtis Mayfield",
                        "question_id": 16,
                        "right_answer": 0
                    }
                ]
            },
            {
                "id": 17,
                "question": "Qui est l\u2019auteur de What\u2019s going on ?",
                "deezer_song_id": null,
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 55,
                        "answer": "Marvin Gaye",
                        "question_id": 17,
                        "right_answer": 1
                    },
                    {
                        "id": 56,
                        "answer": "Stevie Wonder",
                        "question_id": 17,
                        "right_answer": 0
                    },
                    {
                        "id": 57,
                        "answer": "Otis Redding",
                        "question_id": 17,
                        "right_answer": 0
                    }
                ]
            },
            {
                "id": 18,
                "question": "Qui est l\u2019auteur de ce tube sorti en 1976 et qui figurait sur l'album \"Songs in the key of life\" ?",
                "deezer_song_id": "https:\/\/cdns-preview-f.dzcdn.net\/stream\/c-f80b4f6b8f2b0712daa3c720dd63c153-8.mp3",
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 58,
                        "answer": "Stevie Wonder",
                        "question_id": 18,
                        "right_answer": 1
                    },
                    {
                        "id": 59,
                        "answer": "Solomon Burke",
                        "question_id": 18,
                        "right_answer": 0
                    },
                    {
                        "id": 60,
                        "answer": "Al Green",
                        "question_id": 18,
                        "right_answer": 0
                    }
                ]
            },
            {
                "id": 19,
                "question": "A quel label est associ\u00e9 le nom d\u2019Otis Redding ?",
                "deezer_song_id": null,
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 61,
                        "answer": "Motown",
                        "question_id": 19,
                        "right_answer": 0
                    },
                    {
                        "id": 62,
                        "answer": "Crocodile Records",
                        "question_id": 19,
                        "right_answer": 0
                    },
                    {
                        "id": 63,
                        "answer": "Stax",
                        "question_id": 19,
                        "right_answer": 1
                    }
                ]
            },
            {
                "id": 20,
                "question": "Dans quel film de John Landis entend-on des reprises de Soul Man et de Green Onions ?",
                "deezer_song_id": null,
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 64,
                        "answer": "American College",
                        "question_id": 20,
                        "right_answer": 0
                    },
                    {
                        "id": 65,
                        "answer": "Les Blues Brothers",
                        "question_id": 20,
                        "right_answer": 1
                    },
                    {
                        "id": 66,
                        "answer": "Un fauteuil pour deux",
                        "question_id": 20,
                        "right_answer": 0
                    }
                ]
            },
            {
                "id": 21,
                "question": "Quelle est la figure majeure de la Memphis Soul ?",
                "deezer_song_id": null,
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 67,
                        "answer": "Al Green",
                        "question_id": 21,
                        "right_answer": 1
                    },
                    {
                        "id": 68,
                        "answer": "James Brown",
                        "question_id": 21,
                        "right_answer": 0
                    },
                    {
                        "id": 69,
                        "answer": "Barry White",
                        "question_id": 21,
                        "right_answer": 0
                    }
                ]
            },
            {
                "id": 22,
                "question": "Quelle est la figure majeure de la soul de Chicago ?",
                "deezer_song_id": null,
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 70,
                        "answer": "Otis Redding",
                        "question_id": 22,
                        "right_answer": 0
                    },
                    {
                        "id": 71,
                        "answer": "George Clinton",
                        "question_id": 22,
                        "right_answer": 0
                    },
                    {
                        "id": 72,
                        "answer": "Curtis Mayfield",
                        "question_id": 22,
                        "right_answer": 1
                    }
                ]
            },
            {
                "id": 23,
                "question": "Quelle chanson de James Brown inaugure l\u2019\u00e8re du funk ?",
                "deezer_song_id": null,
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 73,
                        "answer": "Night Train",
                        "question_id": 23,
                        "right_answer": 0
                    },
                    {
                        "id": 74,
                        "answer": "Sex machine",
                        "question_id": 23,
                        "right_answer": 1
                    },
                    {
                        "id": 75,
                        "answer": "I feel good",
                        "question_id": 23,
                        "right_answer": 0
                    }
                ]
            },
            {
                "id": 24,
                "question": "Quel groupe disco est l\u2019auteur de la bande originale de \"La fi\u00e8vre du samedi soir\" ?",
                "deezer_song_id": "https:\/\/cdns-preview-3.dzcdn.net\/stream\/c-38e501fef86bda868fbd6114950f3025-5.mp3",
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 76,
                        "answer": "Abba",
                        "question_id": 24,
                        "right_answer": 0
                    },
                    {
                        "id": 77,
                        "answer": "Kool & The Gang",
                        "question_id": 24,
                        "right_answer": 0
                    },
                    {
                        "id": 78,
                        "answer": "Les Bee Gees",
                        "question_id": 24,
                        "right_answer": 1
                    }
                ]
            },
            {
                "id": 25,
                "question": "A ses d\u00e9buts, le rhythm'n'blues d\u00e9signe une forme de blues tr\u00e8s rythmique. Quel est le titre embl\u00e9matique de ce courant musical ?",
                "deezer_song_id": null,
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 79,
                        "answer": "\"I got a woman\" de Ray Charles",
                        "question_id": 25,
                        "right_answer": 1
                    },
                    {
                        "id": 80,
                        "answer": "\"Say a little prayer\" de Aretha Franklin",
                        "question_id": 25,
                        "right_answer": 0
                    },
                    {
                        "id": 81,
                        "answer": "\"Superstition\" de Stevie Wonder",
                        "question_id": 25,
                        "right_answer": 0
                    }
                ]
            },
            {
                "id": 26,
                "question": "Par quel label,  l\u2019auteur compositeur de Soul, Smokey Robinson, est -il produit ?",
                "deezer_song_id": "https:\/\/cdns-preview-f.dzcdn.net\/stream\/c-f67fdb337286ab16abc6446e84b2ab03-2.mp3",
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 82,
                        "answer": "Stax",
                        "question_id": 26,
                        "right_answer": 0
                    },
                    {
                        "id": 83,
                        "answer": "Motown",
                        "question_id": 26,
                        "right_answer": 1
                    },
                    {
                        "id": 84,
                        "answer": "Chess",
                        "question_id": 26,
                        "right_answer": 0
                    },
                    {
                        "id": 85,
                        "answer": "Atlantic",
                        "question_id": 26,
                        "right_answer": 0
                    }
                ]
            },
            {
                "id": 27,
                "question": "Quel est l\u2019un des plus grands interpr\u00e8tes de Southern Soul (Label Stax) ayant interpr\u00e9t\u00e9 \u00ab I can get no (satisfaction) \u00bb ?",
                "deezer_song_id": "https:\/\/cdns-preview-6.dzcdn.net\/stream\/c-63a7cebd2f7cb9dac92d74a093cd4e21-9.mp3",
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 86,
                        "answer": "Mick Jagger",
                        "question_id": 27,
                        "right_answer": 0
                    },
                    {
                        "id": 87,
                        "answer": "James Brown",
                        "question_id": 27,
                        "right_answer": 0
                    },
                    {
                        "id": 88,
                        "answer": "Otis Redding",
                        "question_id": 27,
                        "right_answer": 1
                    }
                ]
            },
            {
                "id": 28,
                "question": "Quel artiste incarne parfaitement la Memphis Soul , plus urbaine, au cours des ann\u00e9es 70 ?",
                "deezer_song_id": "https:\/\/cdns-preview-1.dzcdn.net\/stream\/c-163b229d1664e830eaaf3fc8e3b81ebb-3.mp3",
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 89,
                        "answer": "Marvin Gaye",
                        "question_id": 28,
                        "right_answer": 0
                    },
                    {
                        "id": 90,
                        "answer": "Al Green",
                        "question_id": 28,
                        "right_answer": 1
                    },
                    {
                        "id": 91,
                        "answer": "Otis Redding",
                        "question_id": 28,
                        "right_answer": 0
                    }
                ]
            },
            {
                "id": 29,
                "question": "Durant les ann\u00e9es 60, Chicago est le terrain privil\u00e9gi\u00e9 d\u2019une soul effervescente aux sections de cuivres tr\u00e8s chaudes, notamment sous la houlette d\u2019un c\u00e9l\u00e8bre parolier, musicien, producteur et chanteur, qui forge le \u00ab son de Chicago \u00bb. Lequel ?",
                "deezer_song_id": null,
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 92,
                        "answer": "Curtis Mayfield",
                        "question_id": 29,
                        "right_answer": 1
                    },
                    {
                        "id": 93,
                        "answer": "Prince",
                        "question_id": 29,
                        "right_answer": 0
                    },
                    {
                        "id": 94,
                        "answer": "Lamont Dozier",
                        "question_id": 29,
                        "right_answer": 0
                    }
                ]
            },
            {
                "id": 30,
                "question": "Fin 1974, dans quels termes sera qualifi\u00e9e la soul de Philadelphie (dite Philly Soul) , produite par le trio Bell-Gamble-Huff et dont le groupe O\u2019Jays est repr\u00e9sentatif ?",
                "deezer_song_id": null,
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 95,
                        "answer": "Une soul dans un \u00e9crin de cordes, influenc\u00e9e par la musique classique",
                        "question_id": 30,
                        "right_answer": 0
                    },
                    {
                        "id": 96,
                        "answer": "Une soul aux accents de pop music",
                        "question_id": 30,
                        "right_answer": 0
                    },
                    {
                        "id": 97,
                        "answer": "Une soul sensuelle, caract\u00e9ris\u00e9e par des influences funk et jazz",
                        "question_id": 30,
                        "right_answer": 1
                    }
                ]
            },
            {
                "id": 31,
                "question": "Le funk, consid\u00e9r\u00e9 comme la forme la plus africanis\u00e9e du Rhyhtm'n'blues par sa polyrythmie tr\u00e8s syncop\u00e9e, conna\u00eet son \u00e2ge d\u2019or entre 1970 et 1975. Un artiste, fort charismatique, s\u2019autoproclame le \u00ab ministre \u00bb du funk. Quel est son nom ?",
                "deezer_song_id": null,
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 98,
                        "answer": "Sly Stone",
                        "question_id": 31,
                        "right_answer": 0
                    },
                    {
                        "id": 99,
                        "answer": "James Brown",
                        "question_id": 31,
                        "right_answer": 1
                    },
                    {
                        "id": 100,
                        "answer": "George Clinton",
                        "question_id": 31,
                        "right_answer": 0
                    }
                ]
            },
            {
                "id": 32,
                "question": "Succ\u00e9dant \u00e0 la vague Jazz funk, qui consiste \u00e0 injecter du groove funk dans les structures harmoniques du jazz, certains artistes dans les ann\u00e9es 80 cr\u00e9ent des titres qui m\u00ealent la soul et le jazz classique. Quel guitariste dans ce domaine interpr\u00e9tera \u00ab Give me the night \u00bb ?",
                "deezer_song_id": "https:\/\/cdns-preview-f.dzcdn.net\/stream\/c-fd0eeb0df57aa78a365e81270bd82769-9.mp3",
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 101,
                        "answer": "Jimi Hendrix",
                        "question_id": 32,
                        "right_answer": 0
                    },
                    {
                        "id": 102,
                        "answer": "Eric Clapton",
                        "question_id": 32,
                        "right_answer": 0
                    },
                    {
                        "id": 103,
                        "answer": "George Benson",
                        "question_id": 32,
                        "right_answer": 1
                    }
                ]
            },
            {
                "id": 33,
                "question": "Au mitan des ann\u00e9es 70, les artistes noirs fa\u00e7onnent leur musique afin qu\u2019elle soit diffus\u00e9e dans les discoth\u00e8ques, lieux de loisirs rendues incontournables : leurs morceaux sont format\u00e9s pour \u00eatre dans\u00e9s. Quelle est l\u2019artiste noire  qui eut, d\u00e8s les pr\u00e9misses du disco, une influence majeure, interpr\u00e9tant \u00ab Love to love you baby \u00bb en 1975 ?",
                "deezer_song_id": "https:\/\/cdns-preview-a.dzcdn.net\/stream\/c-a1e0a893e1f30a83f69c0880445bb1ad-8.mp3",
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 104,
                        "answer": "Gloria Gaynor",
                        "question_id": 33,
                        "right_answer": 0
                    },
                    {
                        "id": 105,
                        "answer": "Donna Summer",
                        "question_id": 33,
                        "right_answer": 1
                    },
                    {
                        "id": 106,
                        "answer": "Whitney Houston",
                        "question_id": 33,
                        "right_answer": 0
                    }
                ]
            },
            {
                "id": 34,
                "question": "Dans les ann\u00e9es 80, la vague disco d\u00e9cro\u00eet progressivement et on observe un retour du funk plus soign\u00e9 mais qui est marqu\u00e9 par la m\u00eame dynamique joviale que le disco. En France le terme \u00ab  funky \u00bb s\u2019impose. Quel artiste multi-instrumentiste s\u2019est forg\u00e9 une solide r\u00e9putation dans le domaine de la funk d\u00e8s 1978 ?",
                "deezer_song_id": null,
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 107,
                        "answer": "James Taylor",
                        "question_id": 34,
                        "right_answer": 0
                    },
                    {
                        "id": 108,
                        "answer": "Prince",
                        "question_id": 34,
                        "right_answer": 1
                    },
                    {
                        "id": 109,
                        "answer": "Mikael Jackson",
                        "question_id": 34,
                        "right_answer": 0
                    }
                ]
            },
            {
                "id": 35,
                "question": "La go-go music, style de funk radical, est \u00e0 mi-chemin entre la soul et un autre genre musical. Lequel ?",
                "deezer_song_id": "https:\/\/cdns-preview-3.dzcdn.net\/stream\/c-36062928eda6a5ea073e6d255bd2e070-5.mp3",
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 110,
                        "answer": "La soul et le ska",
                        "question_id": 35,
                        "right_answer": 0
                    },
                    {
                        "id": 111,
                        "answer": "La soul et le hip hop",
                        "question_id": 35,
                        "right_answer": 1
                    },
                    {
                        "id": 112,
                        "answer": "la soul et l\u2019acid-jazz",
                        "question_id": 35,
                        "right_answer": 0
                    },
                    {
                        "id": 113,
                        "answer": "la soul et l'electro",
                        "question_id": 35,
                        "right_answer": 0
                    }
                ]
            },
            {
                "id": 36,
                "question": "La n\u00e9o soul, sorte de retour aux sources de la soul des ann\u00e9es 70 rendue hybride par des apports en jazz, funk, hip hop et house music, est n\u00e9e \u00e0 la fin des ann\u00e9es 90. Le terme n\u00e9o soul fut invent\u00e9 par le producteur Kedar Massanburg du label Motown, qui l\u2019a popularis\u00e9 en l\u2019attribuant \u00e0 quelle artiste ?",
                "deezer_song_id": null,
                "quiz_id": 3,
                "answers": [
                    {
                        "id": 114,
                        "answer": "Lauryn  Hill",
                        "question_id": 36,
                        "right_answer": 0
                    },
                    {
                        "id": 115,
                        "answer": "Beyonc\u00e9",
                        "question_id": 36,
                        "right_answer": 0
                    },
                    {
                        "id": 116,
                        "answer": "Erika Badu",
                        "question_id": 36,
                        "right_answer": 1
                    }
                ]
            }
        ]
    }
]

class Game {

    initialize(quiz) {
        this._round = 0;
        this.questions = quiz['questions'];
        this.played = [];
        this._score = 0;
        this.currentAnswer = 0;
        this._timer = 0;
    }

    testAnswer(id) {
        return this.currentAnswer == id;
    }

    nextQuestion() {
        let randomQuestion = this.questions[(Math.floor(Math.random() * this.questions.length))];
        while (this.played.includes(randomQuestion['id'])) {
            randomQuestion = this.questions[(Math.floor(Math.random() * this.questions.length))];
        }
        this.round++;
        this.played.push(randomQuestion['id']);
        return randomQuestion;
    }
    startTimer() {
        this._timer = Date.now();
    }

    getTimeLapse() {
        return Date.now() - this._timer;
    }

    set timer(time) {
        this._timer = time;
    }

    get timer() {
        return this._timer;
    }

    get round() {
        return this._round;
    }

    set round(newIndex) {
        this._round = newIndex;
    }

    set score(score) {
        this._score = score;
    }

    get score() {
        return this._score;
    }

    addScore(score) {
        this._score += score;
    }
}

var partie = new Game();


function getQuiz(id) {
    // const result = null;
    for (const quiz of quizzes) {
        if (quiz['id'] == id) {
            result = quiz;
        }
    }
    return result;
}

function clickProposition(event) {
    const propositions = document.querySelectorAll(".proposition")
    let timeLapse = partie.getTimeLapse();
    for (const proposition of propositions) {
        console.log(proposition);
        proposition.removeEventListener('click', clickProposition);
        proposition.classList.remove('clickable')
        proposition.classList.remove('hoverable')
    }
    if (partie.testAnswer(event.currentTarget.dataset.id)) {
        event.currentTarget.classList.add('win');
        let bonus = parseInt((100 - timeLapse / 100) / 2);
        console.log("Gagné !!");
        console.log(Math.max(bonus, 0));
        partie.addScore(50 + Math.max(bonus, 0));
    } else {
        event.currentTarget.classList.add('lose');
        console.log("Perdu");
        document.querySelector(`li[data-id="${partie.currentAnswer}"]`).classList.add('win');
    }
    const btnNextQuestion = document.querySelector("#next-question");
    if (partie.round >= 10) {
        btnNextQuestion.addEventListener('click', finishQuiz);
        btnNextQuestion.innerText = "Résultats";
    } else {
        btnNextQuestion.addEventListener('click', showNextQuestion);
    }
    btnNextQuestion.classList.remove('masquer');
    document.querySelector('#points').innerText = partie.score;
}

function finishQuiz() {

}

function showNextQuestion() {
    const template = document.querySelector('#template-question');
    const question = partie.nextQuestion();
    const questionElt = document.importNode(template.content, true);

    questionElt.querySelector('#index-question').innerText = `Question n°${partie.round}`;
    questionElt.querySelector("#text-question").innerText = question['question'];
    for (const answer of question["answers"]) {
        const liElt = document.createElement('li');
        liElt.classList.add("proposition");
        liElt.classList.add("clickable");
        liElt.classList.add("hoverable");
        liElt.innerText = answer['answer'];
        liElt.addEventListener('click', clickProposition);
        liElt.dataset.id = answer['id'];
        if (answer['right_answer']) {
            partie.currentAnswer = answer['id'];
        }
        questionElt.querySelector("#answers").appendChild(liElt);
    }
    const audio = questionElt.querySelector("#track")
    if (question['deezer_song_id'] !== null) {
        audio.src = question['deezer_song_id'];
        // audio.hidden = false;
        audio.onended = function () {
            console.log("lecture audio à la fin");
            audio.currentTime = 0;
            stopAudio();
        }
    } else {
        const button = questionElt.querySelector("#illustration");
        button.src = "https://mediatheque.ville-bourges.fr/basicimagedownload.ashx?itemGuid=CE68E0C6-89BF-49EA-B1F2-FA4B15F1BF95";
        button.classList.remove('audio-buttons');
    }
    const questionZone = document.querySelector('#question');
    questionZone.innerHTML = "";
    questionZone.appendChild(questionElt);
    const btnNextQuestion = document.querySelector("#next-question");
    btnNextQuestion.classList.add('masquer');
    if (question['deezer_song_id'] !== null) {
        startAudio();
    }
    // console.log(question);
    partie.startTimer();
}

function startAudio(event) {
    const questionZone = document.querySelector('#question');
    const audio = questionZone.querySelector("#track");
    const button = questionZone.querySelector("#illustration");
    audio.play();
    button.src = "https://mediatheque.ville-bourges.fr/basicimagedownload.ashx?itemGuid=E998F348-E45B-4C58-B8B0-333D25A1F4B4";
    button.title = "Cliquer pour mettre en pause";
    button.removeEventListener('click', startAudio);
    button.addEventListener('click', stopAudio);
}

function stopAudio(event) {
    const questionZone = document.querySelector('#question');
    const audio = questionZone.querySelector("#track");
    const button = questionZone.querySelector("#illustration");
    audio.pause();
    button.src = "https://mediatheque.ville-bourges.fr/basicimagedownload.ashx?itemGuid=81D5C5FF-4C9F-4719-98EC-BB67C8106384";
    button.title = "Cliquer pour lancer la lecture";
    button.removeEventListener('click', stopAudio);
    button.addEventListener('click', startAudio);
}

function beginQuiz(event) {
    // const quizSelect = document.querySelector('#quiz-select');
    // event.currentTarget.disabled = true;
    const quiz = getQuiz("3");

    partie.initialize(quiz);
    const quizIntroduction = document.querySelector('#introduction');
    quizIntroduction.classList.add('retirer');
    showNextQuestion();
}

function quizSelect(event) {
    const select = event.currentTarget;
    const startQuizBtn = document.querySelector('#startBtn');
    startQuizBtn.disabled = select.value === "";
}

document.addEventListener('DOMContentLoaded', () => {
    // document.querySelector('#quiz-select').addEventListener('change', quizSelect);
    document.querySelector('#startBtn').addEventListener('click', beginQuiz);
    fetch('./quiz.json')
        .then((response) => response.json())
        .then((json) => {
            quizzes = json;
            // for (const quiz of quizzes) {
            //     document.querySelector('#quiz-select').innerHTML += `<option value="${quiz['id']}">${quiz['name']}</option>`;
            // }
        });
});